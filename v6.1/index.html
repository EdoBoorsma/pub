<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OOAPI Documentation</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Open Education API documentation">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

  <!-- Docsify and theme -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/docsify-versioned-plugin@0.0.1/styles.css">
  <link rel="stylesheet" href="../theme.css">
</head>

<body>
  <!-- Version banner rendered dynamically (pub only) -->
  <div id="version-banner"></div>

  <!-- Docsify application root -->
  <div id="app"></div>

  <!-- Docsify configuration -->
  <script>
    /*
     * Load versions.json synchronously.
     * If it does not exist, we assume "docs-repo mode".
     */
    function loadVersionsSync() {
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '../versions.json', false); // synchronous by design
        xhr.send(null);

        if (xhr.status >= 200 && xhr.status < 300) {
          return {
            mode: 'pub',
            data: JSON.parse(xhr.responseText)
          };
        }
      } catch (e) {
        // ignore
      }

      return {
        mode: 'docs',
        data: null
      };
    }

    /*
     * Detect active version from URL path (only meaningful in pub mode)
     * Example: /v6.0/...
     */
    function detectActiveVersionFromPath() {
      const first = location.pathname.split('/').filter(Boolean)[0];
      return first && /^v\d+\.\d+$/.test(first) ? first : null;
    }

    const result = loadVersionsSync();

    let siteName;
    let versionsForDocsify;

    if (result.mode === 'pub') {
      const cfg = result.data;
      const activeVersion = detectActiveVersionFromPath() || cfg.current;

      siteName = 'Open Education API ' + activeVersion.toUpperCase();

      versionsForDocsify = cfg.versions.map(v => ({
        folder : v.id,
        label  : v.status === 'beta'
                 ? (v.label || v.id) + ' (beta)'
                 : (v.label || v.id),
        default: v.id === cfg.current
      }));

      /*
       * Expose version info for banner behaviour
       */
      window.__OOAPI_VERSION_INFO__ = {
        active : activeVersion,
        current: cfg.current,
        beta   : cfg.beta || null,
        meta   : cfg.versions.find(v => v.id === activeVersion) || null
      };

    } else {
      // docs-repo / live-viewer mode
      siteName = 'Open Education API (docs)';
      versionsForDocsify = undefined;
      window.__OOAPI_VERSION_INFO__ = null;
    }

    window.$docsify = {
      repo: 'https://github.com/EdoBoorsma/docs',
      homepage: 'home.md',
      basePath: '',
      search: 'auto',
      name: siteName,
      externalLinkTarget: '_self',
      loadSidebar: true,
      // loadNavbar: true,
      alias: {
        '/.*/_sidebar.md': '/_sidebar.md'
      },
      subMaxLevel: 0,
      maxLevel: 1,          // sidebar nesting depth
      logo: '_media/OpenEducationApi_Logo.png',

      tabs: {
        persist    : true,
        sync       : true,
        theme      : 'classic',
        tabComments: true,
        tabHeadings: true
      },

      /* Available documentation versions (pub only) */
      versions: versionsForDocsify,
      versionSelectorLabel: versionsForDocsify ? 'Version' : undefined
    };
  </script>

  <!-- Docsify core scripts -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/js/docsify-themeable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-tabs@1"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify/lib/plugins/front-matter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify/lib/plugins/zoom-image.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docsify-versioned-plugin@0.0.1/index.js"></script>

  <!-- Custom versioning behaviour (pub only; safe no-op in docs mode) -->
  <script src="../ooapi-versioning.js"></script>
</body>
</html>
